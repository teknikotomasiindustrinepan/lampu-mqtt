<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Lamp - AGRIOT V1.0 - SMK Negeri 1 Japara</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /**
     * KONFIGURASI FIREBASE UNTUK: agriot-classy-japara
     * Pastikan API KEY asli disalin dari Firebase Console.
     */
    const myLocalConfig = {
      apiKey: "AIzaSy...", 
      authDomain: "agriot-classy-japara.firebaseapp.com",
      projectId: "agriot-classy-japara",
      storageBucket: "agriot-classy-japara.appspot.com",
      messagingSenderId: "GANTI_SENDER_ID",
      appId: "GANTI_APP_ID"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' 
      ? JSON.parse(__firebase_config) 
      : myLocalConfig;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'agriot-classy-japara';

    // Konfigurasi MQTT & Redirect
    const TOPIC_STATUS = "lampu/esp32_01/status";
    const TOPIC_CMD = "lampu/esp32_01/cmd";
    const REDIRECT_URL = "https://teknikotomasiindustrinepan.github.io/agriot_classy/";

    // State Aplikasi
    let currentUser = null;
    let lastStatus = null; 
    let isSynced = false;

    // UI Elements
    const statusText = document.getElementById("status-text");
    const lampWrapper = document.getElementById("lamp-wrapper");
    const mqttText = document.getElementById("mqtt-text");
    const mqttDot = document.getElementById("mqtt-dot");
    const mqttPill = document.getElementById("mqtt-status-pill");

    // Inisialisasi Chart
    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Status',
          data: [],
          borderColor: '#60a5fa',
          backgroundColor: 'rgba(96, 165, 250, 0.2)',
          borderWidth: 2,
          pointRadius: 3,
          stepped: true,
          fill: true,
          tension: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true, grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } } },
          y: {
            min: -0.1, max: 1.1,
            ticks: {
              stepSize: 1,
              color: 'rgba(255,255,255,0.3)',
              callback: function(value) { return value === 1 ? 'ON' : 'OFF'; }
            },
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      }
    });

    const fullHistory = [];
    function addDataToChart(status) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('id-ID');
      const val = (status === "ON") ? 1 : 0;
      
      // Hindari duplikasi log jika status sama dengan data terakhir di chart
      if (activityChart.data.datasets[0].data.length > 0) {
        const lastVal = activityChart.data.datasets[0].data[activityChart.data.datasets[0].data.length - 1];
        if (lastVal === val) return; 
      }

      fullHistory.push({ tanggal: now.toLocaleDateString('id-ID'), waktu: timeStr, status: status });
      activityChart.data.labels.push(timeStr);
      activityChart.data.datasets[0].data.push(val);
      if (activityChart.data.labels.length > 15) {
        activityChart.data.labels.shift();
        activityChart.data.datasets[0].data.shift();
      }
      activityChart.update('none');
    }

    function updateUI(status) {
      if (!status) return;
      const finalStatus = status.includes("ON") ? "ON" : "OFF";
      
      statusText.innerText = finalStatus;
      statusText.classList.remove("sync-pulse");
      
      if (finalStatus === "ON") {
        statusText.classList.remove("text-white/20");
        statusText.classList.add("text-amber-400", "drop-shadow-[0_0_12px_rgba(251,191,36,0.6)]");
        lampWrapper.className = "bulb-container status-on";
      } else {
        statusText.classList.remove("text-amber-400", "drop-shadow-[0_0_12px_rgba(251,191,36,0.6)]");
        statusText.classList.add("text-white/20");
        lampWrapper.className = "bulb-container status-off";
      }
      addDataToChart(finalStatus);
    }

    // 1. Inisialisasi Auth
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth Error:", error);
      }
    };
    initAuth();

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        const statusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'lamp_status', 'latest');
        
        // Ambil data awal segera setelah login agar tidak "OFF" default
        try {
          const initialSnap = await getDoc(statusDocRef);
          if (initialSnap.exists()) {
            const data = initialSnap.data();
            if (!isSynced) { // Hanya jika belum diupdate oleh MQTT
                lastStatus = data.status;
                updateUI(data.status);
                isSynced = true;
            }
          }
        } catch (err) {
          console.error("Initial Fetch Error:", err);
        }

        // Jalankan listener realtime
        onSnapshot(statusDocRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.status !== lastStatus) {
                lastStatus = data.status;
                updateUI(data.status);
                isSynced = true;
            }
          }
        });
      }
    });

    // 3. Koneksi MQTT
    const mqttOptions = { 
        clientId: 'agriot_web_' + Math.random().toString(16).substr(2, 8),
        connectTimeout: 30000,
        keepalive: 60,
        reconnectPeriod: 5000, 
        clean: true
    };
    
    const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", mqttOptions);

    client.on("connect", () => {
      mqttText.innerText = "MQTT Connected";
      mqttDot.className = "w-1.5 h-1.5 mr-2 rounded-full bg-green-400";
      mqttPill.className = "inline-flex items-center px-3 py-1 mt-4 rounded-full text-[9px] font-bold bg-green-500/20 text-green-300 border border-green-500/50 uppercase tracking-tighter";
      client.subscribe(TOPIC_STATUS, { qos: 1 });
      // Minta status terbaru dari ESP32
      client.publish(TOPIC_CMD, "GET_STATUS", { qos: 1 });
    });

    client.on("message", async (topic, message) => {
      const msg = message.toString().trim().toUpperCase();
      if (topic === TOPIC_STATUS) {
        // Hanya update jika status berubah dari yang ada di memori
        if (msg !== lastStatus) {
            lastStatus = msg;
            updateUI(msg);
            isSynced = true;
        }
        
        // Selalu simpan status terbaru ke database setiap kali ada pesan MQTT masuk
        if (currentUser) {
          try {
            const statusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'lamp_status', 'latest');
            await setDoc(statusDocRef, { 
                status: msg, 
                updatedAt: new Date().toISOString()
            }, { merge: true });
          } catch (e) {}
        }
      }
    });

    window.handleLogout = async () => {
      const btn = event.currentTarget;
      btn.innerHTML = "REDIRECTING...";
      btn.disabled = true;
      document.body.classList.add("fade-out");
      try {
        if (client && client.connected) client.end(true);
        await signOut(auth);
        setTimeout(() => window.location.replace(REDIRECT_URL), 300);
      } catch (err) {
        window.location.href = REDIRECT_URL;
      }
    };

    window.lampOn = () => {
        if (client.connected) client.publish(TOPIC_CMD, "ON", { qos: 1 });
        else alert("Menunggu koneksi MQTT...");
    };
    window.lampOff = () => {
        if (client.connected) client.publish(TOPIC_CMD, "OFF", { qos: 1 });
        else alert("Menunggu koneksi MQTT...");
    };
    window.exportReport = () => {
        if (fullHistory.length === 0) return alert("Log kosong");
        let csv = "Tanggal,Waktu,Status\n";
        fullHistory.forEach(r => { csv += `${r.tanggal},${r.waktu},${r.status}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'agriot_log.csv';
        a.click();
    };
  </script>

  <style>
    :root { --on-color: #fbbf24; --off-color: #94a3b8; }
    body {
      background: #0f172a;
      background-image: radial-gradient(at 0% 0%, rgba(30, 58, 138, 0.3) 0, transparent 50%), 
                        radial-gradient(at 50% 0%, rgba(15, 23, 42, 0.9) 0, transparent 50%);
      font-family: 'Inter', sans-serif; transition: opacity 0.5s ease;
      overflow-x: hidden;
    }
    .glass-morphism { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .bulb-container { position: relative; width: 100px; height: 100px; margin: 0 auto 1.5rem; }
    .status-on .bulb-glow { fill: var(--on-color); filter: drop-shadow(0 0 30px rgba(251, 191, 36, 0.8)); }
    .status-off .bulb-glow { fill: rgba(255, 255, 255, 0.05); }
    .sync-pulse { animation: pulse-blue 2s infinite; }
    @keyframes pulse-blue { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    .fade-out { opacity: 0; pointer-events: none; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <div class="fixed top-6 right-6 z-50">
    <button onclick="handleLogout()" class="glass-morphism px-4 py-2 rounded-2xl text-white text-xs font-bold flex items-center gap-2 hover:bg-white/10 transition-all active:scale-95 border border-white/10">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
      KELUAR
    </button>
  </div>

  <div class="glass-morphism rounded-[3rem] shadow-2xl p-8 w-full max-sm text-center text-white relative">
    <header class="mb-8">
      <h1 class="text-3xl font-black tracking-tighter">AGRIOT <span class="text-blue-500">V1.0</span></h1>
      <p class="text-[10px] font-bold text-blue-400/60 uppercase tracking-[0.3em] mt-1">SMK Negeri 1 Japara</p>
      
      <div id="mqtt-status-pill" class="inline-flex items-center px-3 py-1 mt-6 rounded-full text-[9px] font-bold bg-white/5 text-white/40 border border-white/10 uppercase tracking-tighter">
        <span id="mqtt-dot" class="w-1.5 h-1.5 mr-2 rounded-full bg-white/20"></span>
        <span id="mqtt-text">Mencoba Terhubung...</span>
      </div>
    </header>

    <div id="lamp-wrapper" class="bulb-container status-off">
      <svg class="w-full h-full" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path class="bulb-glow" d="M12,2A7,7,0,0,0,5,9c0,3.11,2.1,5.73,5,6.6V19a2,2,0,0,0,2,2,2,2,0,0,0,2-2V15.6c2.9-.87,5-3.49,5-6.6A7,7,0,0,0,12,2Z"/>
        <path d="M9,21h6v1a1,1,0,0,1-1,1H10a1,1,0,0,1-1-1Z" fill="rgba(255,255,255,0.2)"/>
      </svg>
    </div>

    <div class="mb-8">
      <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1 font-bold">Status Lampu</p>
      <div id="status-text" class="text-5xl font-black text-white/10 sync-pulse uppercase tracking-tighter">SYNC...</div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-8">
      <button onclick="lampOn()" class="bg-blue-600 hover:bg-blue-500 active:scale-95 transition-all text-white text-xs font-black py-4 rounded-3xl shadow-xl shadow-blue-900/20 uppercase tracking-widest">
        ON
      </button>
      <button onclick="lampOff()" class="bg-white/5 hover:bg-white/10 active:scale-95 transition-all text-white text-xs font-black py-4 rounded-3xl border border-white/10 uppercase tracking-widest">
        OFF
      </button>
    </div>

    <div class="p-4 bg-black/20 rounded-[2rem] border border-white/5">
      <div class="flex justify-between items-center mb-4">
        <span class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Riwayat Aktif</span>
        <button onclick="exportReport()" class="text-[8px] bg-white/5 hover:bg-white/10 px-2 py-1 rounded-lg border border-white/10 font-bold">EXPORT</button>
      </div>
      <div class="h-[150px]">
        <canvas id="activityChart"></canvas>
      </div>
    </div>
  </div>
</body>
</html>
