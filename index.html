<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grafik Lampu MQTT</title>

  <!-- MQTT -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h2>Grafik Status Lampu</h2>

<canvas id="lampuChart" width="400" height="200"></canvas>

<script>
  // Koneksi MQTT
  const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

  const TOPIC_HISTORY = 'smk/japara/lampu/history';

  // Data grafik
  const labels = [];
  const dataValues = [];

  const ctx = document.getElementById('lampuChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Lampu (ON=1, OFF=0)',
        data: dataValues,
        borderWidth: 2,
        stepped: true
      }]
    },
    options: {
      scales: {
        y: {
          min: 0,
          max: 1,
          ticks: {
            stepSize: 1,
            callback: v => v === 1 ? 'ON' : 'OFF'
          }
        }
      }
    }
  });

  client.on('connect', () => {
    client.subscribe(TOPIC_HISTORY);
  });

  client.on('message', (topic, message) => {
    if (topic === TOPIC_HISTORY) {
      const history = JSON.parse(message.toString());

      labels.length = 0;
      dataValues.length = 0;

      history.forEach(item => {
        labels.push(item.time.substring(11,19));
        dataValues.push(item.value);
      });

      chart.update();
    }
  });
</script>

</body>
</html>
