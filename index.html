<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Lampu Virtual MQTT + Grafik</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; text-align:center; }
button { padding:10px 20px; margin:5px; }
.lampu {
  width:120px;height:120px;border-radius:50%;
  margin:20px auto;background:gray;
}
.on { background:yellow; box-shadow:0 0 30px gold; }
</style>
</head>

<body>

<h2>Lampu Virtual MQTT</h2>

<button onclick="sendCmd('ON')">Lampu ON</button>
<button onclick="sendCmd('OFF')">Lampu OFF</button>

<div id="lampu" class="lampu"></div>
<p>Status: <b id="statusText">-</b></p>

<hr>

<h3>Grafik Riwayat Lampu</h3>
<canvas id="lampuChart" width="400"></canvas>

<script>
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

const TOPIC_CMD = "smk/japara/lab1/cmd/lampu";
const TOPIC_STATUS = "smk/japara/lab1/status/lampu";
const TOPIC_HISTORY = "smk/japara/lampu/history";

// Chart
const labels = [];
const values = [];

const chart = new Chart(document.getElementById('lampuChart'), {
  type:'line',
  data:{ labels, datasets:[{ label:'Lampu', data:values, stepped:true }]},
  options:{
    scales:{ y:{ min:0,max:1,ticks:{stepSize:1,callback:v=>v?'ON':'OFF'}}}
  }
});

client.on("connect",()=>{
  client.subscribe([TOPIC_STATUS, TOPIC_HISTORY]);
});

client.on("message",(topic,msg)=>{
  const data = JSON.parse(msg.toString());

  if(topic===TOPIC_STATUS){
    document.getElementById("lampu").className =
      "lampu "+(data.status==="ON"?"on":"");
    document.getElementById("statusText").innerText=data.status;
  }

  if(topic===TOPIC_HISTORY){
    labels.length=0; values.length=0;
    data.forEach(d=>{
      labels.push(d.time.substring(11,19));
      values.push(d.value);
    });
    chart.update();
  }
});

function sendCmd(cmd){
  client.publish(TOPIC_CMD, JSON.stringify({command:cmd}));
}
</script>

</body>
</html>
